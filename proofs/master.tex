\documentclass{amsart}
\usepackage{bcprules,url}
\allowdisplaybreaks
\swapnumbers
\newtheorem{theorem}[subsection]{Theorem}
\newtheorem{lemma}[subsection]{Lemma}
\newtheorem{corollary}[subsection]{Corollary}
\theoremstyle{definition}
\newtheorem{definition}[subsection]{Definition}

\input{../paper/macros.tex}
\begin{document}

\section{Syntax}

\begin{syntax}
\mbox{polytype}\\
\sigma, \tau & ::=
& \rho & \mbox{where }\FTV(\rho)=\emptyset
\\
\\
\mbox{prenex}\\
\rho & ::= &
\forall \alpha_0\alpha_1\ldots~
\exists \beta_0\beta_1\ldots~\theta
&
\mbox{where }\alpha_i,\beta_j\in\FTV(\theta)
\\
\\
\mbox{open type}\\
\theta
&::=& \alpha \Or \beta \Or \gamma \Or \cdots &\mbox{type variable}\\
& | & \mu &\mbox{monotype}\\
& | & \theta \R \theta &\mbox{open function type}
\\
\\
\mbox{monotype}\\
\mu
&::=& \iota_0 \Or \iota_1 \Or \cdots &\mbox{base type}\\
& | & \mu \R \mu &\mbox{function type}
\\
\\
\mbox{term}\\
t & ::= & x & \mbox{variable} \\
& | & \Abs{x:\rho}t  & \mbox{lambda abstraction} \\
& | & t~t & \mbox{function application} \\
& | & \mbox{primitives}
\end{syntax}

\section{Semantics}

\subsection{Domain}
The domain of values $V$ is the solution to the following domain
equations.
% not using amalgamated sums coz wanna distinguish the function
% that's nonterminating on all arguments and nontermination
% itself.
\begin{align*}
V &= B_0 + B_1 + \cdots + F + \{Wrong\}
  &&\mbox{disjoint sum of domains}\\
F &= V \R V &&\mbox{continuous functions from $V$ to $V$}
\end{align*}

\subsection{Denotation of types}
Monotype and polytypes denote subsets of $V$.
\begin{align*}
V^{\iota_i} &= \{\bot_V\}\cup B_i &&\mbox{base values}
\\
V^{\mu_0 \R \mu_1} &=
  \{\bot_V\}\cup
  \{f\in F \Or f(V^{\mu_0}) \subseteq V^{\mu_1}\}
  &&\mbox{function values}
\end{align*}
Note that a function type $(\mu_0\R\mu_1)$ does \emph{not} denote
continuous functions from the input domain $V^{\mu_0}$ to the
output domain $V^{\mu_1}$. Its denotation is constructed to also
contains all polymorphic functions whose type instantiates to 
$(\mu_0\R\mu_1)$.
\begin{align*}
V^{\forall\alpha_0\alpha_1\ldots~\theta} &=
  \bigcap_{\mu_i}
  \theta[\alpha_0\mapsto\mu_0,\alpha_1\mapsto\mu_1,\ldots]
\\
V^{\exists\beta_0\beta_1\ldots~\theta} &=
  \bigcup_{\mu_j'}
  \theta[\beta_0\mapsto\mu_0',\beta_1\mapsto\mu_1',\ldots]
\\
V^{\forall\alpha_0\alpha_1\ldots~\exists\beta_0\beta_1\ldots~\theta}
&=\bigcap_{\mu_i}
  \bigcup_{\mu_j'} \theta[
  \alpha_0\mapsto\mu_0,\alpha_1\mapsto\mu_1,\ldots,
  \beta_0\mapsto\mu_0',\beta_1\mapsto\mu_1',\ldots]
\end{align*}
The typed value domains $V^\tau$ are a straightforward extension
of the notion of types as ideals in Milner~\cite{Milner78}.

\begin{lemma}
For each mono- or polytype $\tau$, the set of values $V^\tau$ is
an ideal of $V$.
\end{lemma}

\begin{proof}[Proof sketch]
Milner~\cite{Milner78} asserts that $V^\tau$ is an ideal when
$\tau$ is a monotype. Set intersection preserves idealhood.
Countable union poses a problem. The definition of ideal in MTD%
%
\footnote{Stoltenberg-Hansen, Lindstr\"om,
Griffor. \emph{Mathematical Theory of Domains.}}
%
doesn't involve the supremum of an infinite number of values, and
is preserved by countable union. I'm not sure what to do about
the notion of ideals in Milner~\cite{Milner78}.
\end{proof}

\subsection{Denotation of terms} Terms denote values as if they
were untyped. Primitives may denote anything in $V$, as long as
the value of each primitive operator satisfies strong type
soundness.


\section{Constraint-based subtyping}

We define a syntactic relation $\Sub$ on polytypes. We call it
the \emph{subtype} relation because $\sigma \Sub \tau$ implies
$V^\sigma \subseteq V^\tau$ (theorem~\ref{subsound}).

\subsection{Syntax of constraints}~

\begin{syntax}
\mbox{degrees of freedom}\\
\Delta
&::=& \emptyset \\
&|& \alpha,\Delta
\\
\\
\mbox{list of constraints}\\
C
&::=& \emptyset \\
&|& \rho_0 \Sub \rho_1, C
\end{syntax}

\subsection{Derivation of constraint judgements}~

\infrule[C-Refl]
{}
{\Delta \vdash \rho_0\Sub\rho_0,\rho_1\Sub\rho_1,
\ldots,\rho_n\Sub\rho_n}

TODO: separate quantifier lifting from {\sc C-Arrow} into another rule.

Need not argue that we implement all the rules here.
We can implement any weaker subtyping relation, any weaker typing
relation. Soundness holds through.

\infrule[C-Arrow]
{
\arraycolsep=1pt
\begin{array}[b]{rl}
\bar\alpha &= \bar\alpha_0,\bar\alpha_1,\bar\alpha_{01}\\
\bar\alpha_0 &\subseteq \FTV(\theta_0) - \FTV(\theta_1)\\
\bar\alpha_1 &\subseteq \FTV(\theta_1) - \FTV(\theta_0)\\
\bar\alpha_{01} &\subseteq \FTV(\theta_0) \cap \FTV(\theta_1)\\
\bar\beta &= \bar\beta_0,\bar\beta_1,\bar\beta_{01}\\
&\vdots\\
\bar\delta_{23} &\subseteq \FTV(\theta_2) \cap \FTV(\theta_3)
\end{array}
\andalso
\begin{array}[b]{rcl}
\Delta,\bar\alpha_{01},\bar\delta_{23} &~\vdash~&
(\All{\bar\delta_2}\Ex{\bar\gamma_2}\theta_2)
\Sub
(\All{\bar\beta_0}\Ex{\bar\alpha_0}\theta_0),
\\ &&
(\All{\bar\alpha_1}\Ex{\bar\beta_1}\theta_1)
\Sub
(\All{\bar\gamma_3}\Ex{\bar\delta_3}\theta_3),
\\ &&
C
\end{array}
}
{\Delta\vdash
(\All{\bar\alpha} \Ex{\bar\beta} \theta_0 \R \theta_1)
\Sub
(\All{\bar\gamma} \Ex{\bar\delta} \theta_2 \R \theta_3)
,C}


\infrule[C-Loner]
{\alpha\notin\Delta\cup\FTV(C)
\andalso
\Delta\vdash
\{ \rho_i\Sub\rho_j' \Or 0 \le i \le m, 0 \le j \le n \}
\cup C
}
{
\Delta,\alpha \vdash
\rho_0\Sub\alpha,\ldots,\rho_m\Sub\alpha,
\alpha\Sub\rho_0',\ldots,\alpha\Sub\rho_n',C
}

\begin{definition}
[Subtype relation]
A polytype $\sigma$ is a subtype of another polytype $\tau$, writ
$\sigma \Sub \tau$, if there exists a derivation of
$\emptyset\vdash\sigma\Sub\tau$.
\end{definition}

\begin{theorem}
[Soundness of subtyping]
\label{subsound}
$V^\sigma\subseteq V^\tau$ whenever $\sigma\Sub\tau$.
\end{theorem}

\begin{proof}[Proof idea]
Induction on derivation of constraint judgements, with the
following induction hypothesis:

A monotype instantiation of $\Delta$ is a substitution where each
type variable in $\Delta$ is mapped to a monotype. If there is a
derivation of $\Delta\vdash C$, then for each monotype
instantiation $f$ of $\Delta$ and each constraint
$\rho_0\Sub\rho_1$ in $C$, we have $V^{f(\rho_0)}\subseteq
V^{f(\rho_1)}$.
\end{proof}

\begin{definition}
[Loner; unsure whether will be useful]
\label{loner}
A type variable $\alpha$ is a loner in the constraint list $C$ if
\begin{enumerate}
\item $C$ contains constraints of the form
$\alpha\Sub\rho$ or $\rho\Sub\alpha$ with
$\alpha\notin\FTV(\rho)$, and
\item $\alpha$ never occurs free in other constraints of $C$.
\end{enumerate}
If $\alpha$ is a loner in $C$, then
\begin{align*}
\LHS(\alpha)&=\{\rho \Or (\rho\Sub\alpha) \in C\}\\
\RHS(\alpha)&=\{\rho \Or (\alpha\Sub\rho) \in C\}\\
\end{align*}
\end{definition}



\input{bib.tex}\end{document}
