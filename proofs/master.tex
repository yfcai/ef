\documentclass{amsart}
\usepackage{bcprules,url,enumerate}
\allowdisplaybreaks
\swapnumbers
\newtheorem{theorem}[subsection]{Theorem}
\newtheorem{lemma}[subsection]{Lemma}
\newtheorem{corollary}[subsection]{Corollary}
\theoremstyle{definition}
\newtheorem{definition}[subsection]{Definition}

\def\thesubsection{\arabic{subsection}}

\title{Nuclear Football Megaslave}

\input{../paper/macros.tex}
\begin{document}

\maketitle
\tableofcontents

\subsection{Syntax}
\begin{syntax}
\mbox{type}\\
\sigma, \tau
&::=& \iota_0 \Or \iota_1 \Or \cdots &\mbox{base type}\\
&|& \alpha \Or \beta \Or \cdots & \mbox{type variable} \\
&|& \tau \rightarrow \tau & \mbox{function type} \\
&|& \All\alpha\tau & \mbox{universal type}
\\
\\
\mbox{term}\\
s, t & ::= & x & \mbox{variable} \\
& | & \Abs{x:\tau}t  & \mbox{lambda abstraction} \\
& | & t~t & \mbox{function application} \\
& | & \cdots & \mbox{primitives}
\end{syntax}

\subsection{Syntax of subtype judgements}

\begin{syntax}
\mbox{list of type variables}\\
A,E
&::=& \emptyset \\
&|& \alpha,A
\\
\\
\mbox{list of constraints}\\
C
&::=& \emptyset \\
&|& \sigma \Sub \tau, C
\\
\\
\mbox{subtype judgement}
&::=&A;E\vdash C
\end{syntax}

\subsection{Derivation of subtype judgements}~

\infrule[S-vacuous]
{}
{A;E\vdash\emptyset}

\infrule[S-Refl]
{\FTV(\tau)\subseteq A\cup E
\andalso
A;E\vdash C
}
{A;E \vdash \tau\Sub\tau,C}

\infrule[S-Arrow]
{A;E\vdash\tau_0\Sub\sigma_0,\sigma_1\Sub\tau_1,C}
{A;E\vdash\sigma_0\R\sigma_1\Sub\tau_0\R\tau_1,C}

\infrule[S-Loner]
{\alpha\notin A\cup E\cup\FTV(C)
\andalso
A;E\vdash
\{ \sigma_i\Sub\tau_j \Or 0 \le i \le m, 0 \le j \le n \}
\cup C
}{
\alpha,A;E \vdash
\sigma_0\Sub\alpha,\ldots,\sigma_m\Sub\alpha,
\alpha\Sub\tau_0,\ldots,\alpha\Sub\tau_n,C
}

\infrule[S-Al]
{\alpha\notin A\cup E\cup\FTV(\tau)\cup\FTV(C)
\andalso
\alpha,A;E\vdash\sigma\Sub\tau,C}
{A;E\vdash(\All\alpha\sigma)\Sub\tau,C}

\infrule[S-Er]
{\alpha\notin A\cup E\cup\FTV(\tau)\cup\FTV(C)
\andalso
A;\alpha,E\vdash\sigma\Sub\tau,C}
{A;E\vdash\sigma\Sub(\All\alpha\tau),C}

% Reason of existence: CT-App.
\infrule[S-Dupe]
{A;E\vdash \sigma\Sub\tau, C}
{A;E\vdash \sigma\Sub\tau, \sigma\Sub\tau, C}

% Reason of existence: CT-App.

% Reason of existence: Substitution lemma.
\infrule[S-Trans]
{A;E\vdash \sigma\Sub\tau,\tau\Sub\tau',C}
{A;E\vdash \sigma\Sub\tau',C}

\subsection{Constrained typing}
\begin{syntax}
\mbox{constrained type}
&::=&\tau \Given C
\\\\
\mbox{constrained typing judgement}
&::=&\Gamma \vdash t : \tau \Given C
\end{syntax}%
\infrule[CT-Var]
{x:\tau\in\Gamma}
{\Gamma\vdash x : \tau \Given \emptyset}

\infrule[CT-Abs]
{
\Gamma,x:\sigma \vdash t : \tau \Given C}
{\Gamma\vdash (\Abs{x:\sigma}t) : \sigma\R\tau \Given C}

\infrule[CT-App]
{
\Gamma\vdash s : \sigma \Given C_1
\andalso
\Gamma\vdash t : \tau \Given C_2}
{\Gamma\vdash s~t : \beta \Given
\sigma\Sub\alpha\R\beta,\tau\Sub\alpha,C_1\cup C_2}

\subsection{Substitution lemma}
We set out to prove that if $t$ can be typed $\tau_0$, then after
a well-typed substitution it can still be typed $\tau_0$.

Let $\Piggy$ be a set of ``piggy-backed'' constraints. Suppose
the following judgements are derivable.
\begin{align}
\Gamma,x:\sigma_x&\vdash t:\tau\Given C_t \notag
\\
\Gamma&\vdash v:\sigma_v \Given C_v \notag
\\
A;\emptyset&\vdash
\sigma_v\Sub\sigma_x, \tau\Sub\tau_0,C_t\cup C_v\cup\Piggy
\label{eq:subass}
\end{align}
Then there exists $A'$ such that we can derive
\begin{align*}
A';\Gamma&\vdash t[x\mapsto v] : \tau'\Given C',\\
A';\emptyset &\vdash \tau'\Sub\tau_0, C_t\cup C_v\cup C'\cup\Piggy.
\end{align*}

\begin{proof}
By induction on a constrained typing derivation of $t$ and by
case analysis on the last rule used.

\Case\textsc{CT-Var}: We know $t=x$. The assumptions are
specialized to the simple form below.
\begin{samepage}
\begin{align}
\Gamma,x:\sigma&\vdash x:\sigma_x\Given\emptyset
\notag
\\
\Gamma&\vdash v:\sigma_v\Given C_v
\label{eq:subvar1}
\\
A;\emptyset&\vdash \sigma_v\Sub\sigma_x,\sigma_x\Sub\tau_0,C_v\cup\Piggy
\label{eq:subvar2}
\end{align}
\end{samepage}%
Since $t[x\mapsto v]=v$, the desired constrained typing judgement
is exactly \eqref{eq:subvar1}. The desired subtype judgement
follows from one use of \textsc{S-Trans} on \eqref{eq:subvar2}.
\[
A;\emptyset\vdash \sigma_v\Sub\tau_0,C_v\cup\Piggy.
\]

\Case\textsc{CT-Abs}: $t=\Abs{y:\sigma_y}s$.
\def\yasump{\Gamma,y:\sigma_y\vdash s:\tau_s\Given C_s}
\infrule[CT-Abs]
{\yasump}
{\Gamma\vdash(\Abs{y:\sigma_y}s):\sigma_y\R\tau_s \Given C_s}
Assumption~\eqref{eq:subass} translates to
\[
A;\emptyset\vdash
\sigma_v\Sub\sigma_x,
\sigma_y\R\tau_s\Sub\tau_0,C_s\cup C_v\cup\Piggy.
\]
By \textsc{S-Refl},
\[
A;\emptyset\vdash
    \tau_s\Sub\tau_s,
\sigma_v\Sub\sigma_x,
\sigma_y\R\tau_s\Sub\tau_0,C_s\cup C_v\cup\Piggy.
\]
Since the constrained typing of $t$ contains a derivation for
\[\yasump,\]
we invoke the induction hypothesis with the piggyback
$(\sigma_y\R\tau_s\Sub\tau_0,\Piggy)$ to conclude that for some
appropriate $A'$ and argument type annotations,
\begin{align}
s'&=s[x\mapsto v]\notag
\\
A';\Gamma,y:\sigma_y&\vdash s' : \tau_s'\Given C'
\label{eq:subabs1}
\\
A';\emptyset&\vdash
    \tau_s'\Sub\tau_s,
\sigma_y\R\tau_s\Sub\tau_0,C_s\cup C_v\cup C'\cup\Piggy.
\label{eq:subabs2}
\end{align}
By \eqref{eq:subabs1} and \textsc{CT-Abs},
\[
A';\Gamma\vdash(\Abs{y:\sigma_y}.s)[x\mapsto v] : \sigma_y\R\tau_s'\Given C'.
\]
By \eqref{eq:subabs2} and \textsc{S-Refl},
\[
A';\emptyset\vdash
    \sigma_y\Sub\sigma_y,
    \tau_s'\Sub\tau_s,
\sigma_y\R\tau_s\Sub\tau_0,C_s\cup C_v\cup C'\cup\Piggy.
\]
\textsc{S-Arrow} produces
\[
A';\emptyset\vdash
    \sigma_y\R\tau_s'\Sub\sigma_y\R\tau_s,
\sigma_y\R\tau_s\Sub\tau_0,C_s\cup C_v\cup C'\cup\Piggy
\]
and \textsc{S-Trans} concludes
\[
A';\emptyset\vdash
    \sigma_y\R\tau_s'\Sub\tau_0,
C_s\cup C_v\cup C'\cup\Piggy.
\]

\Case\textsc{CT-App}: $t=s_1~s_2$.
\infrule[CT-App]
{
\Gamma\vdash s_1:\sigma_1\Given C_1
\andalso
\Gamma\vdash s_2:\sigma_2\Given C_2
}
{\Gamma\vdash s_1~s_2:\beta\Given
\sigma_1\Sub\alpha\R\beta,\sigma_2\Sub\alpha,C_1\cup C_2
}
Set
\[
C_t=\sigma_1\Sub\alpha\R\beta,\sigma_2\Sub\alpha,C_1\cup C_2,
\]
then assumption~\eqref{eq:subass} becomes
\[
A;\emptyset\vdash
  \sigma_v\Sub\sigma_x,
  \beta\Sub\tau_0,
  C_t\cup C_v\cup\Piggy.
\]
Set
\[
D=
\sigma_1\Sub\alpha\R\beta,
\sigma_1\Sub\alpha\R\beta,
\sigma_2\Sub\alpha,
\sigma_2\Sub\alpha,C_1\cup C_2\cup C_v.
\]
Some uses of \textsc{S-Dupe} and \textsc{S-Refl} produce
\[
A;\emptyset\vdash
  \sigma_1\Sub\sigma_1,
  \sigma_v\Sub\sigma_x,\sigma_v\Sub\sigma_x,
  \beta\Sub\tau_0,
  D\cup\Piggy.
\]
Invoking the induction hypothesis on $s_1$, we obtain
\begin{align}
s_1'&=s_1[x\mapsto v]\notag,
\\
\Gamma&\vdash s_1' : \sigma_1' \Given C_1',
\label{eq:subapp1}
\\
A_1';\emptyset&\vdash
  \sigma_v\Sub\sigma_x,
  \sigma_1'\Sub\sigma_1,
  \beta\Sub\tau_0,
  D\cup\Piggy.
\label{eq:subapp2}
\end{align}
From \eqref{eq:subapp2}, \textsc{S-Refl} produces
\begin{align}
A_1';\emptyset\vdash
  \sigma_2\Sub\sigma_2,
  \sigma_v\Sub\sigma_x,
  \sigma_1'\Sub\sigma_1,
  \beta\Sub\tau_0,
  D\cup C_1'\cup\Piggy.
\label{eq:subappf}
\end{align}
Invoking the induction hypothesis on $s_2$ and \eqref{eq:subapp2}
produces
\begin{align}
A_2';\emptyset&\vdash
  \sigma_1'\Sub\sigma_1,
  \sigma_2'\Sub\sigma_2,
  \beta\Sub\tau_0,
  D\cup C_1'\cup C_2'\cup\Piggy
\notag\\
&\vdash
  \beta\Sub\tau_0,
  \sigma_1'\Sub\sigma_1,
  \sigma_2'\Sub\sigma_2,
  % dfn of C_t
  \sigma_1\Sub\alpha\R\beta,\sigma_2\Sub\alpha,
  C_t\cup C_v\cup C_1'\cup C_2'\cup\Piggy,
\notag
\end{align}
the last step by expanding $D$ partially to
$\sigma_1\Sub\alpha\R\beta,\sigma_2\Sub\alpha,C_t\cup C_v$.
Two uses of \textsc{S-Trans} gives us
\begin{align}
A_2';\emptyset\vdash
  \beta\Sub\tau_0,
  \sigma_1'\Sub\alpha\R\beta,\sigma_2'\Sub\alpha,
  C_t\cup C_v\cup C_1'\cup C_2'\cup\Piggy.
\label{eq:subapps}
\end{align}
Use existing type variables $\alpha$, $\beta$ to construct the
desired constrained typing.
\begin{align}
t'&=s_1[x\mapsto v]~s_2[x\mapsto v]
\notag\\
\Gamma&\vdash t':
\beta\Given
\sigma_1'\Sub\alpha\R\beta,\sigma_2'\Sub\alpha,
C_1'\cup C_2'
\notag
\end{align}
The desired subtype judgement is derived already: it is
\eqref{eq:subapps}.
\end{proof}

\input{bib.tex}\end{document}
