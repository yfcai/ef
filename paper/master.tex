\documentclass{amsart}
\usepackage[foot]{amsaddr}
\usepackage{bcprules,url,verbatim,multicol}

\let\phi=\varphi % default phi looks like empty set
\allowdisplaybreaks
\swapnumbers
\newtheorem{theorem}[subsection]{Theorem}
\newtheorem{lemma}[subsection]{Lemma}
\newtheorem{corollary}[subsection]{Corollary}

\input{macros.tex}

\def\CT0{$\text{CT}_0$}

\title[The MPS model of possibly negative algebraic data types]
{The MacQueen-Plotkin-Sethi model of
\\
possibly negative algebraic data types}

\begin{document}

\maketitle

\section{Domain-wise, what is a type?}

\Par{Value domain}

$V$ is a set containing all functions definable in untyped lambda
calculus. It is the solution of the following equation up to
set-theoretic isomorphism:
\begin{equation}\label{domain-eq}
V \cong B + (V + V) + (V \times V) + (V \R V) + \{\bot, \top\}.
\end{equation}
Here, $B$ is any set of base values. In a practical programming
language, its members are often truth values, integers and
floating point numbers. The symbol $+$ denotes disjoint union,
and $\times$ denotes cartesian product. They give rise to a
\emph{definedness} partial order $\Sub$ under which $\bot$ is
always the least element, $\top$ is always the greatest element,
and members of $B$ are incomparable with one another. The
definedness partial order $\Sub$ determines a Scott topology on
$V$, and the function space $(V \R V)$ consists of the continuous
functions of the Scott topology. We will talk about Scott
topologies later. For now, it suffices to appreciate that $V$
contains base values, function values and values of (not
necessarily positive) algebraic data types.

There are a number of ways to construct $V$. We may argue for the
isomorphism in equation~\eqref{domain-eq} in terms of compact
elements of Scott-Ershov domains, or we may argue in terms of
continuous lattices; it makes no difference when we discuss
types. We will only use the Scott topology on $V$, which is
required for the space of continuous functions $(V\R V)$ to be
well-defined at all.

Previous works define an extra member $\Wrong$ of $V$ to stand
for runtime type errors. We use the maximum element $\top$ for
runtime type errors instead, so that $\Wrong$ does not have to be
purposefully excluded from every type. In fact, our types are
closed nonempty proper subsets of $V$ under its Scott topology.

\Par{Scott topology} The solution to domain
equation~\eqref{domain-eq} should impose a \emph{definedness}
partial order $\Sub$ on $V$ satisfying the following properties.
\begin{itemize}
\item $\bot$ is the least element: $\bot\Sub v$ for all $v\in V$.
\item $\top$ is the greatest element: $v\Sub\top$ for all $v\in
V$.
\item Base values are incomparable: If $u,v\in B$, then
$u\not\Sub v$ and $v\not\Sub u$.
\item (Should we mention that directed subsets are supposed to
have least upper bounds? Will we even need directed closedness?
Will downsets do?)
\end{itemize}
A topology of $V$ is any labeling of subsets of $V$ as
\emph{open} such that
\begin{itemize}
\item $\emptyset$ and $V$ are open,
\item the union of any family of open sets is open,
\item the intersection of a finite number of open sets is open.
\end{itemize}
We mentioned that the function space $(V\R V)$ consists of the
continuous functions according to the Scott topology. A function
is continuous according to a topology if its preimage of an open
set is an open set.

\begin{samepage}
The Scott topology of $V$ labels a subset $S$ open if it
satisfies the following conditions.
\begin{itemize}
\item $S$ is \emph{upward-closed}: If $u\in S$ and $u\Sub v$,
then $v\in S$.
\item $S$ is \emph{inaccessible by directed supremums}: If $A$ is
a directed set disjoint from $S$, then the supremum of $A$ is
outside $S$.
\end{itemize}
\end{samepage}

A set is \emph{closed} if it is the complement of an open set.

\begin{lemma}[Characterizing closed sets of Scott topology]
A set $S\subseteq V$ is closed under Scott topology if and
only if it satisfies the following conditions.
\begin{itemize}
\item $S$ is \emph{downward-closed}: If $v\Sub u$ and $u\in S$,
then $v\in S$.
\item $S$ is \emph{closed under directed supremums}: If
$A$ is a directed subset of $S$, then the supremum of $A$ is a
member of $S$.
\end{itemize}
\end{lemma}

\begin{proof}
$S$ is downward-closed if and only if its complement is
upward-closed. $S$ is closed under directed supremums if and only
if its complement is inaccessible by directed supremums.
\end{proof}

\Par{Types}

A subset of $V$ is a \emph{type} if it is a proper closed set
under the Scott topology. In other words, types are nonempty
proper subsets of $V$ closed downward and under directed
supremums. If $v\in T$, then we say that the value $v$
\emph{inhabits} the type $T$, and that $v$ is an
\emph{inhabitant} of $T$.

\begin{lemma}
$\bot$ inhabits every type. $\top$ does not inhabit any type.
\end{lemma}

\section{Recursively defined types}

\Par{Road map}

Let us reproduce the result by MacQueen, Plotkin and Sethi that
types can be defined by recursive equations. For example, the
type of heterogeneous lists is defined by the equation
\[
\texttt{List} = \texttt{Unit} + (V \times \texttt{List}),
\]
which holds with set-theoretic identity. The argument has 3
steps.
\begin{enumerate}
\item Define the distance between every pair of types, and
establish completeness of the resulting metric space in the sense
that every Cauchy sequence of types converges to a type.
\item Show that the product, sum and function type constructions
are contractive in both arguments,
\item Invoke the Banach fixed-point theorem on the nonempty
complete metric space of types to show that every contraction
mapping between types has a unique fixed point. By (2), a
recursive type equation defines a unique type if its right hand
side uses only the product, sum and function type constructions.
\end{enumerate}

\Par{Converging sequences of sets}
Let us recall the standard definition of convergence.

The \emph{limit superior} of an infinite sequence of sets
$S_1,S_2,\ldots$ is
\[
\limsup_{n\rightarrow\infty}S_n =
\bigcap_{n=1}^\infty\bigcup_{i = n}^\infty S_i.
\]
The \emph{limit inferior} is
\[
\liminf_{n\rightarrow\infty}S_n =
\bigcup_{n=1}^\infty\bigcap_{i = n}^\infty S_i.
\]
If the limit superior and limit inferior are equal, then the
sequence $S_1,S_2,\ldots$ \emph{converges}, and its \emph{limit}
is
\[
S = \limsup_{n\rightarrow\infty}S_n = \liminf_{n\rightarrow\infty}S_n.
\]

\Par{Metric space of types}

Let ``$\Rank$'' be an arbitrary function from $V$ to $\mathbb R$.
The proximity of two types $S$, $T$ is the smallest rank of a
value in the symmetric difference of $S$ and $T$. If $S=T$, then
their proximity is $\infty$. The distance $d(S, T)$ between two
types is inverse exponential in their proximity:
\[
d(S,T) =
\left(\frac12\right)^{\mathrm{proximity}(S, T)}
%\frac1{2 ^{\mathrm{proximity}(S, T)}} % looks worse
 \]
It is easy to verify that the distance function $d$ satisfies the
requirements for forming a metric space over the set of types:
It is nonnegative, evaluates to $0$ only on equal types, is
commutative, and satisfies a stronger inequality than the
triangle inequality:
\[
d(R,T)\le\max(d(R,S),d(S,T)).
\]
To see it, let $v$ be the value of minimum rank $r$ in the
symmetric difference between $R$~and $T$, and suppose $v\in R-T$.
Then $d(R, T)=2^{-r}$. If $v\in S$, then $v\in S-T$ and
$d(S,T)\ge2^{-r}$. If $v\notin S$, then $d(R, S)\ge2^{-r}$.

\Par{Cauchy sequences}

An infinite sequence $T_1,T_2,\ldots$ of types is Cauchy if for
every $\epsilon > 0$ there exists $n\in\mathbb N$ such that for
all $i,j\ge n$, the distance between $T_i$~and $T_j$ is smaller
than $\epsilon$.

\begin{theorem}
No matter which rank function is chosen, the metric space of
types is complete in the sense that every Cauchy sequence of
types converges to a type.
\end{theorem}

\begin{proof}
There are two proof goals.
\begin{enumerate}
\item Every Cauchy sequence of types converges.
\item The limit of a Cauchy sequence of types is a type.
\end{enumerate}

Part (1). Let $T_1,T_2,\ldots$ be a Cauchy sequence of types.
Knowing the standard result $\liminf T_n\subseteq\limsup T_n$,
we need only show $\limsup T_n\subseteq\liminf T_n$.

\def\Cauchy{\texttt{cauchy}}
\def\Hasv{{\texttt{has\textunderscore}v}}

Choose an arbitrary value
\[
v\in \limsup T_n = \bigcap_{n=1}^\infty\bigcup_{i = n}^\infty T_i.
\]
Let $\epsilon=2^{-\Rank(v)}>0$. There exists a natural number
$\Cauchy$ such that for all $i,j\ge\Cauchy$, we have
$d(T_i,T_j)<\epsilon$. Since $v$ is a member of the limit
superior, there exists a natural number $\Hasv\ge\Cauchy$ such
that $v\in T_\Hasv$. If we pick any $i\ge\Hasv$, then we have
$v\in T_i$, because otherwise the contradiction
\[
d(T_\Hasv, T_i)\ge2^{-\Rank(v)}=\epsilon
\]
would arise. Thus
\[
v\in
\bigcap_{i=\Hasv}^\infty T_i\subseteq
\bigcup_{n=1}^\infty\bigcap_{i = n}^\infty T_i.
=\liminf T_n.
\]

Part (2). We will verify that the limit
\[
T=\limsup T_n=\liminf T_n
\]
is closed downward and closed under directed supremum.
\end{proof}

\end{document}
